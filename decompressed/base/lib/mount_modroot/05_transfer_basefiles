#!/bin/sh

upperdir=$1
overlay_bank=/overlay/bank_2

move_overlay() {
  #use the www folder as check to know that we should populate the modoverlay (mtd3) and cleanup real overlay (mtd2)
  if [ -d $overlay_bank/www ]; then

    #iterate all bank_2 folders and file to merge content with the one on modoverlay
    for file in $(find "$overlay_bank/"*/ -xdev | cut -d '/' -f4-); do
      #create folder if not exist on destination
      if [[ -d "$overlay_bank/$file" && ! -d "$upperdir/$file" ]]; then
        mkdir "$upperdir/$file"
        continue
      fi

      #if not a dir move the file (and symlink)
      [ ! -d "$overlay_bank/$file" ] && mv -f "$overlay_bank/$file" "$upperdir/$file"

    done

    #at this point we should remove all empty folders in bank_2 overlay, except the modoverlay mountpoint
    for f in "$overlay_bank/"*; do
      [ "$f" != "$overlay_bank$upperdir" ] && rm -rf "$f"
    done

  fi
}

preserve_files(){
  #these files should be moved back to bank_2 overlay to allow our mount hook to take place (and preserve root after boot)
  preserve_list="/etc/init.d/rootdevice /etc/rc.d/S94rootdevice /usr/sbin/random_seed /sbin/mount_root-mod /lib/mount_modroot/05_transfer_basefiles"

  update_file_if_needed() { # <file> <source> <dest>
    cmp -s "$2$1" "$3$1" || cp -a "$2$1" "$3$1"
  }

  for f in $preserve_list; do
    mkdir -p $overlay_bank$(dirname "$f")
    update_file_if_needed "$f" "$upperdir" $overlay_bank
  done
}

move_overlay
preserve_files
