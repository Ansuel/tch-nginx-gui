#!/bin/sh

upperdir=$1
overlay_bank=/overlay/bank_2

move_overlay() {
  echo "mount_root-mod: checking if overlay must be transfered..." > /dev/kmsg 
  #use the config folder as check to know that we should populate the modoverlay (mtd3) and cleanup real overlay (mtd2)
  if [ -d $overlay_bank/etc/config ]; then

    echo "mount_root-mod: copying $overlay_bank/* to $upperdir/ ..." > /dev/kmsg 
    #copy all file from overlay_bank to modoverlay keeping all attributes and links
    find $overlay_bank -mindepth 1 -maxdepth 1 ! -path "*/modoverlay" -exec cp -a "{}" "$upperdir/" \;

    sync

    #at this point we should remove all empty folders in bank_2 overlay, except the modoverlay mountpoint
    for f in "$overlay_bank/"*; do
      echo "mount_root-mod: check-for-rm $f" > /dev/kmsg 
      [ "$f" != "$overlay_bank/modoverlay" ] && [ "$f" != "$overlay_bank/saferoot" ] && rm -rf "$f"
    done

    sync
  fi
}

preserve_files(){
  #these files should be moved back to bank_2 overlay to allow our mount hook to take place (and preserve root after boot)
  preserve_list="/etc/init.d/rootdevice /etc/rc.d/S94rootdevice /usr/sbin/random_seed /usr/sbin/mount_modoverlay /sbin/mount_root-mod /lib/mount_modroot/05_transfer_basefiles"

  update_file_if_needed() { # <file> <source> <dest>
    cmp -s "$2$1" "$3$1" || cp -a "$2$1" "$3$1"
  }

  for f in $preserve_list; do
    mkdir -p $overlay_bank$(dirname "$f")
    echo "mount_root-mod: update_file_if_needed $f" > /dev/kmsg 
    update_file_if_needed "$f" "$upperdir" $overlay_bank
  done

  sync
}

{ move_overlay; preserve_files; reboot }
